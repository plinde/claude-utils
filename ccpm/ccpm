#!/usr/bin/env bash
# ccpm - Claude Code Plugin Manager
#
# A wrapper around `claude plugin` commands for managing multiple marketplaces.
#
# Usage:
#   ccpm discover                                   # Import installed marketplaces
#   ccpm update [org/repo]                         # Fetch latest catalogs, show changes
#   ccpm upgrade [org/repo] [--dry-run]            # Update + reinstall changed plugins
#   ccpm add <org/repo> <alias>                    # Add marketplace mapping
#   ccpm remove <org/repo>                         # Remove marketplace mapping
#   ccpm list                                      # List configured marketplaces
#   ccpm config                                    # Show config file path
#
# Options:
#   --config <path>        Use alternate config file
#
# Configuration: ~/.config/ccpm.yaml (default)

set -euo pipefail

# Default config location (can be overridden with --config)
DEFAULT_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
DEFAULT_CONFIG_FILE="$DEFAULT_CONFIG_DIR/ccpm.yaml"
CONFIG_FILE="$DEFAULT_CONFIG_FILE"
PLUGINS_DIR="$HOME/.claude/plugins/marketplaces"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Ensure config directory exists
ensure_config() {
    local config_dir
    config_dir=$(dirname "$CONFIG_FILE")
    if [[ ! -d "$config_dir" ]]; then
        mkdir -p "$config_dir"
    fi
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# ccpm - Claude Code Plugin Manager configuration
# Format: repo: alias
marketplaces: {}
EOF
    fi
}

# Show config path
cmd_config() {
    echo -e "${BLUE}Config file:${NC} $CONFIG_FILE"
    if [[ "$CONFIG_FILE" != "$DEFAULT_CONFIG_FILE" ]]; then
        echo -e "${YELLOW}(overridden from default: $DEFAULT_CONFIG_FILE)${NC}"
    fi
    echo
    if [[ -f "$CONFIG_FILE" ]]; then
        echo -e "${GREEN}Status:${NC} exists"
        echo -e "${BLUE}Contents:${NC}"
        cat "$CONFIG_FILE"
    else
        echo -e "${YELLOW}Status:${NC} not created yet (will be created on first 'add' or 'discover')"
    fi
}

# Get alias for a repo from config
get_alias() {
    local repo="$1"
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo ""
        return
    fi
    # Parse YAML manually (avoid yq dependency)
    grep -A1000 "^marketplaces:" "$CONFIG_FILE" 2>/dev/null | \
        grep "^  ${repo}:" 2>/dev/null | \
        sed 's/.*: *//' | \
        tr -d '"' | \
        tr -d "'" || echo ""
}

# Get all configured repos
get_all_repos() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        return
    fi
    grep -A1000 "^marketplaces:" "$CONFIG_FILE" 2>/dev/null | \
        grep "^  [a-zA-Z]" 2>/dev/null | \
        sed 's/:.*//' | \
        sed 's/^  //' || true
}

# Parse org/repo from git remote URL
parse_repo_from_remote() {
    local url="$1"
    # Handle git@github.com:org/repo.git
    if [[ "$url" =~ git@github\.com:([^/]+)/([^/.]+)(\.git)?$ ]]; then
        echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
        return
    fi
    # Handle https://github.com/org/repo.git
    if [[ "$url" =~ https://github\.com/([^/]+)/([^/.]+)(\.git)?$ ]]; then
        echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
        return
    fi
    echo ""
}

# Discover installed marketplaces and import to config
cmd_discover() {
    echo -e "${BLUE}=== Discovering Installed Marketplaces ===${NC}"
    echo

    if [[ ! -d "$PLUGINS_DIR" ]]; then
        echo "No marketplaces directory found at $PLUGINS_DIR"
        return 1
    fi

    ensure_config

    local discovered=0
    local imported=0

    for dir in "$PLUGINS_DIR"/*/; do
        [[ ! -d "$dir" ]] && continue

        local alias
        alias=$(basename "$dir")
        ((discovered++))

        # Get git remote
        local remote
        remote=$(git -C "$dir" remote get-url origin 2>/dev/null || echo "")

        if [[ -z "$remote" ]]; then
            echo -e "  ${YELLOW}⚠${NC}  $alias ${DIM}(no git remote, skipping)${NC}"
            continue
        fi

        # Parse org/repo from remote
        local repo
        repo=$(parse_repo_from_remote "$remote")

        if [[ -z "$repo" ]]; then
            echo -e "  ${YELLOW}⚠${NC}  $alias ${DIM}(could not parse repo from: $remote)${NC}"
            continue
        fi

        # Check if already in config
        local existing_alias
        existing_alias=$(get_alias "$repo")

        if [[ -n "$existing_alias" ]]; then
            echo -e "  ${DIM}✓${NC}  $alias ${DIM}($repo already configured)${NC}"
        else
            # Add to config
            add_marketplace_to_config "$repo" "$alias"
            echo -e "  ${GREEN}+${NC}  $alias ${DIM}($repo)${NC}"
            ((imported++))
        fi
    done

    echo
    echo -e "Discovered ${discovered} marketplace(s), imported ${GREEN}${imported}${NC} new."
}

# Add marketplace to config (internal helper)
add_marketplace_to_config() {
    local repo="$1"
    local alias="$2"

    if grep -q "^  ${repo}:" "$CONFIG_FILE" 2>/dev/null; then
        # Update existing
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s|^  ${repo}:.*|  ${repo}: ${alias}|" "$CONFIG_FILE"
        else
            sed -i "s|^  ${repo}:.*|  ${repo}: ${alias}|" "$CONFIG_FILE"
        fi
    else
        # Add new entry
        if grep -q "^marketplaces: {}" "$CONFIG_FILE"; then
            # Replace empty marketplaces
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' "s|^marketplaces: {}|marketplaces:\\
  ${repo}: ${alias}|" "$CONFIG_FILE"
            else
                sed -i "s|^marketplaces: {}|marketplaces:\\n  ${repo}: ${alias}|" "$CONFIG_FILE"
            fi
        else
            # Append to marketplaces section
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' "/^marketplaces:/a\\
  ${repo}: ${alias}
" "$CONFIG_FILE"
            else
                sed -i "/^marketplaces:/a\\  ${repo}: ${alias}" "$CONFIG_FILE"
            fi
        fi
    fi
}

# Add a marketplace mapping
cmd_add() {
    local repo="$1"
    local alias="$2"

    ensure_config
    add_marketplace_to_config "$repo" "$alias"
    echo -e "${GREEN}Added${NC} ${repo} -> ${alias}"
}

# Remove a marketplace mapping
cmd_remove() {
    local repo="$1"

    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "No config file found"
        return 1
    fi

    if ! grep -q "^  ${repo}:" "$CONFIG_FILE" 2>/dev/null; then
        echo "Marketplace not found: $repo"
        return 1
    fi

    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "/^  ${repo}:/d" "$CONFIG_FILE"
    else
        sed -i "/^  ${repo}:/d" "$CONFIG_FILE"
    fi
    echo -e "${GREEN}Removed${NC} ${repo}"
}

# List configured marketplaces
cmd_list() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "No marketplaces configured."
        echo "Run 'ccpm discover' to import installed marketplaces."
        echo "Or add one with: ccpm add <org/repo> <alias>"
        return
    fi

    echo -e "${BLUE}Configured marketplaces:${NC}"
    echo
    printf "  %-50s %-25s %s\n" "REPO" "ALIAS" "STATUS"
    printf "  %-50s %-25s %s\n" "----" "-----" "------"

    while IFS= read -r repo; do
        [[ -z "$repo" ]] && continue
        local alias
        alias=$(get_alias "$repo")
        local status=""
        if [[ -d "$PLUGINS_DIR/$alias" ]]; then
            status="${GREEN}installed${NC}"
        else
            status="${YELLOW}not installed${NC}"
        fi
        printf "  %-50s %-25s %b\n" "$repo" "$alias" "$status"
    done < <(get_all_repos)
}

# Get list of changed plugin directories between two commits
get_changed_plugins() {
    local marketplace_dir="$1"
    local old_hash="$2"
    local new_hash="$3"

    # Get list of changed files, extract top-level directories that are plugins
    git -C "$marketplace_dir" diff --name-only "$old_hash" "$new_hash" 2>/dev/null | \
        cut -d'/' -f1 | \
        sort -u | \
        while read -r dir; do
            # Only include if it's a plugin directory
            if [[ -d "$marketplace_dir/$dir/.claude-plugin" ]]; then
                echo "$dir"
            fi
        done
}

# Update marketplace catalogs (like apt update)
# Returns changed plugins info but doesn't reinstall
do_update() {
    local aliases=("$@")

    echo -e "${BLUE}=== Fetching marketplace updates ===${NC}"
    echo

    local total_available=0

    for alias in "${aliases[@]}"; do
        local marketplace_dir="$PLUGINS_DIR/$alias"

        if [[ ! -d "$marketplace_dir" ]]; then
            echo -e "  ${DIM}$alias: not installed, skipping${NC}"
            continue
        fi

        # Get current commit hash
        local old_hash
        old_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ -z "$old_hash" ]]; then
            echo -e "  ${YELLOW}$alias: not a git repo, skipping${NC}"
            continue
        fi

        echo -n "  $alias... "

        # Update the marketplace
        claude plugin marketplace update "$alias" >/dev/null 2>&1 || true

        # Get new commit hash
        local new_hash
        new_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ "$old_hash" == "$new_hash" ]]; then
            echo -e "${DIM}up to date${NC}"
            continue
        fi

        # Get list of changed plugins
        local changed
        changed=$(get_changed_plugins "$marketplace_dir" "$old_hash" "$new_hash")

        if [[ -z "$changed" ]]; then
            echo -e "${DIM}updated (no plugin changes)${NC}"
            continue
        fi

        local count
        count=$(echo "$changed" | wc -l | tr -d ' ')
        echo -e "${GREEN}${count} plugin(s) can be upgraded${NC}"
        ((total_available += count))

        # List changed plugins
        while IFS= read -r plugin_name; do
            [[ -z "$plugin_name" ]] && continue
            echo -e "    ${DIM}$plugin_name${NC}"
        done <<< "$changed"
    done

    echo
    if [[ $total_available -eq 0 ]]; then
        echo -e "${DIM}All plugins up to date.${NC}"
    else
        echo -e "${YELLOW}${total_available} plugin(s) can be upgraded.${NC} Run 'ccpm upgrade' to install."
    fi
}

# Upgrade plugins (like apt upgrade)
# Fetches updates and reinstalls changed plugins
do_upgrade() {
    local dry_run="$1"
    shift
    local aliases=("$@")

    if [[ "$dry_run" == true ]]; then
        echo "DRY RUN MODE - no changes will be made"
        echo
    fi

    echo -e "${BLUE}=== Upgrading plugins ===${NC}"
    echo

    local total_updated=0
    local any_changes=false

    for alias in "${aliases[@]}"; do
        local marketplace_dir="$PLUGINS_DIR/$alias"

        if [[ ! -d "$marketplace_dir" ]]; then
            echo -e "  ${DIM}$alias: not installed, skipping${NC}"
            continue
        fi

        # Get current commit hash
        local old_hash
        old_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ -z "$old_hash" ]]; then
            echo -e "  ${YELLOW}$alias: not a git repo, skipping${NC}"
            continue
        fi

        echo -n "  $alias... "

        if [[ "$dry_run" == false ]]; then
            # Update the marketplace
            claude plugin marketplace update "$alias" >/dev/null 2>&1 || true
        fi

        # Get new commit hash
        local new_hash
        new_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ "$old_hash" == "$new_hash" ]]; then
            echo -e "${DIM}up to date${NC}"
            continue
        fi

        # Get list of changed plugins
        local changed
        changed=$(get_changed_plugins "$marketplace_dir" "$old_hash" "$new_hash")

        if [[ -z "$changed" ]]; then
            echo -e "${DIM}no plugin changes${NC}"
            continue
        fi

        local count
        count=$(echo "$changed" | wc -l | tr -d ' ')
        echo -e "${GREEN}${count} plugin(s) to upgrade${NC}"
        any_changes=true

        # Reinstall changed plugins
        while IFS= read -r plugin_name; do
            [[ -z "$plugin_name" ]] && continue

            echo -n "    $plugin_name... "

            if [[ "$dry_run" == true ]]; then
                echo "would reinstall"
            else
                # Uninstall and reinstall
                if claude plugin uninstall "$plugin_name@$alias" >/dev/null 2>&1; then
                    if claude plugin install "$plugin_name@$alias" >/dev/null 2>&1; then
                        echo -e "${GREEN}upgraded${NC}"
                        ((total_updated++))
                    else
                        echo "failed to install"
                    fi
                else
                    # Maybe not installed, try just installing
                    if claude plugin install "$plugin_name@$alias" >/dev/null 2>&1; then
                        echo -e "${GREEN}installed${NC}"
                        ((total_updated++))
                    else
                        echo "failed"
                    fi
                fi
            fi
        done <<< "$changed"
    done

    echo
    if [[ "$any_changes" == false ]]; then
        echo -e "${DIM}All plugins up to date.${NC}"
    else
        echo -e "${GREEN}Done!${NC} Upgraded $total_updated plugin(s)."
    fi
}

# Get target aliases from repos or all configured
get_target_aliases() {
    local target_repos=("$@")
    local target_aliases=()

    if [[ ${#target_repos[@]} -gt 0 ]]; then
        for repo in "${target_repos[@]}"; do
            local alias
            alias=$(get_alias "$repo")
            if [[ -z "$alias" ]]; then
                echo -e "${RED}Error:${NC} Unknown marketplace '$repo'" >&2
                echo "Run 'ccpm discover' or add it with: ccpm add $repo <alias>" >&2
                return 1
            fi
            target_aliases+=("$alias")
        done
    else
        # No specific repos, use all configured
        while IFS= read -r repo; do
            [[ -z "$repo" ]] && continue
            local alias
            alias=$(get_alias "$repo")
            [[ -n "$alias" ]] && target_aliases+=("$alias")
        done < <(get_all_repos)
    fi

    if [[ ${#target_aliases[@]} -eq 0 ]]; then
        echo "No marketplaces configured." >&2
        echo "Run 'ccpm discover' to import installed marketplaces." >&2
        echo "Or add one with: ccpm add <org/repo> <alias>" >&2
        return 1
    fi

    printf '%s\n' "${target_aliases[@]}"
}

# Update command (fetch catalogs, show available upgrades)
cmd_update() {
    local target_repos=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            */*)
                target_repos+=("$1")
                shift
                ;;
            *)
                echo -e "${RED}Error:${NC} Unknown argument '$1'"
                return 1
                ;;
        esac
    done

    local target_aliases
    if ! target_aliases=$(get_target_aliases "${target_repos[@]+"${target_repos[@]}"}"); then
        return 1
    fi

    # shellcheck disable=SC2086
    do_update $target_aliases
}

# Upgrade command (update + reinstall changed plugins)
cmd_upgrade() {
    local dry_run=false
    local target_repos=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                dry_run=true
                shift
                ;;
            */*)
                target_repos+=("$1")
                shift
                ;;
            *)
                echo -e "${RED}Error:${NC} Unknown argument '$1'"
                return 1
                ;;
        esac
    done

    local target_aliases
    if ! target_aliases=$(get_target_aliases "${target_repos[@]+"${target_repos[@]}"}"); then
        return 1
    fi

    # shellcheck disable=SC2086
    do_upgrade "$dry_run" $target_aliases
}

# Show usage
usage() {
    cat << EOF
Usage: ccpm [options] <command>

Commands:
  discover               Discover and import installed marketplaces
  update [org/repo]      Fetch latest catalogs, show available upgrades
  upgrade [org/repo]     Fetch + reinstall changed plugins
  add <org/repo> <alias> Add marketplace to config
  remove <org/repo>      Remove marketplace from config
  list                   List configured marketplaces
  config                 Show config file path and contents
  help                   Show this help

Options:
  --config <path>        Use alternate config file (default: $DEFAULT_CONFIG_FILE)
  --dry-run              Show what would be upgraded without making changes (for upgrade)

Examples:
  ccpm discover                              # Import installed marketplaces
  ccpm update                                # Check for updates (like apt update)
  ccpm upgrade                               # Install updates (like apt upgrade)
  ccpm upgrade --dry-run                     # Preview what would be upgraded
  ccpm upgrade anthropics/skills             # Upgrade specific marketplace
  ccpm add anthropics/skills anthropic-skills
  ccpm list
EOF
}

# Main
main() {
    # Pre-parse --config flag (must come before other args)
    local args=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --config)
                shift
                if [[ $# -lt 1 ]]; then
                    echo -e "${RED}Error:${NC} --config requires a path argument"
                    exit 1
                fi
                CONFIG_FILE="$1"
                shift
                ;;
            *)
                args+=("$1")
                shift
                ;;
        esac
    done
    set -- "${args[@]+"${args[@]}"}"

    # No arguments - show help
    if [[ $# -eq 0 ]]; then
        usage
        exit 0
    fi

    # Parse command
    local cmd="$1"
    shift

    case "$cmd" in
        discover)
            cmd_discover
            ;;
        update)
            cmd_update "$@"
            ;;
        upgrade)
            cmd_upgrade "$@"
            ;;
        add)
            if [[ $# -lt 2 ]]; then
                echo "Usage: ccpm add <org/repo> <alias>"
                exit 1
            fi
            cmd_add "$1" "$2"
            ;;
        remove)
            if [[ $# -lt 1 ]]; then
                echo "Usage: ccpm remove <org/repo>"
                exit 1
            fi
            cmd_remove "$1"
            ;;
        list)
            cmd_list
            ;;
        config)
            cmd_config
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            echo -e "${RED}Error:${NC} Unknown command '$cmd'"
            echo "Run 'ccpm help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
