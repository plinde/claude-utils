#!/usr/bin/env bash
# ccpm - Claude Code Plugin Manager
#
# A wrapper around `claude plugin` commands for managing multiple marketplaces.
#
# Usage:
#   ccpm discover                                   # Import installed marketplaces
#   ccpm update [org/repo]                         # Fetch latest catalogs, show changes
#   ccpm upgrade [org/repo] [--dry-run]            # Update + reinstall changed plugins
#   ccpm search <query> [-v]                       # Search plugins in local repos
#   ccpm reinstall <plugin@mp> [--dry-run]         # Reinstall specific plugin(s)
#   ccpm uninstall <plugin@mp>                     # Uninstall specific plugin(s)
#   ccpm add <org/repo> <alias>                    # Add marketplace mapping
#   ccpm remove <org/repo>                         # Remove marketplace mapping
#   ccpm list [alias]                              # List configured marketplaces and plugins
#   ccpm list --plugins <pattern>                  # List installed plugins matching pattern
#   ccpm check-conflicts                           # Check for naming conflicts
#   ccpm config                                    # Show config file path
#
# Options:
#   --config <path>        Use alternate config file
#
# Configuration: ~/.config/ccpm.yaml (default)

set -euo pipefail

# Exit on Ctrl+C (don't let loops continue after interrupt)
trap 'echo -e "\n${RED}Interrupted${NC}"; exit 130' INT

# Default config location (can be overridden with --config)
DEFAULT_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
DEFAULT_CONFIG_FILE="$DEFAULT_CONFIG_DIR/ccpm.yaml"
CONFIG_FILE="$DEFAULT_CONFIG_FILE"
PLUGINS_DIR="$HOME/.claude/plugins/marketplaces"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Ensure config directory exists
ensure_config() {
    local config_dir
    config_dir=$(dirname "$CONFIG_FILE")
    if [[ ! -d "$config_dir" ]]; then
        mkdir -p "$config_dir"
    fi
    if [[ ! -f "$CONFIG_FILE" ]]; then
        cat > "$CONFIG_FILE" << 'EOF'
# ccpm - Claude Code Plugin Manager configuration
# Format: repo: alias
marketplaces: {}
EOF
    fi
}

# Show config path
cmd_config() {
    echo -e "${BLUE}Config file:${NC} $CONFIG_FILE"
    if [[ "$CONFIG_FILE" != "$DEFAULT_CONFIG_FILE" ]]; then
        echo -e "${YELLOW}(overridden from default: $DEFAULT_CONFIG_FILE)${NC}"
    fi
    echo
    if [[ -f "$CONFIG_FILE" ]]; then
        echo -e "${GREEN}Status:${NC} exists"
        echo -e "${BLUE}Contents:${NC}"
        cat "$CONFIG_FILE"
    else
        echo -e "${YELLOW}Status:${NC} not created yet (will be created on first 'add' or 'discover')"
    fi
}

# Get alias for a repo from config
get_alias() {
    local repo="$1"
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo ""
        return
    fi
    # Parse YAML manually (avoid yq dependency)
    grep -A1000 "^marketplaces:" "$CONFIG_FILE" 2>/dev/null | \
        grep "^  ${repo}:" 2>/dev/null | \
        sed 's/.*: *//' | \
        tr -d '"' | \
        tr -d "'" || echo ""
}

# Get all configured repos
get_all_repos() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        return
    fi
    grep -A1000 "^marketplaces:" "$CONFIG_FILE" 2>/dev/null | \
        grep "^  [a-zA-Z]" 2>/dev/null | \
        sed 's/:.*//' | \
        sed 's/^  //' || true
}

# Parse org/repo from git remote URL
parse_repo_from_remote() {
    local url="$1"
    # Handle git@github.com:org/repo.git
    if [[ "$url" =~ git@github\.com:([^/]+)/([^/.]+)(\.git)?$ ]]; then
        echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
        return
    fi
    # Handle https://github.com/org/repo.git
    if [[ "$url" =~ https://github\.com/([^/]+)/([^/.]+)(\.git)?$ ]]; then
        echo "${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
        return
    fi
    echo ""
}

# Discover installed marketplaces and import to config
cmd_discover() {
    echo -e "${BLUE}=== Discovering Installed Marketplaces ===${NC}"
    echo

    if [[ ! -d "$PLUGINS_DIR" ]]; then
        echo "No marketplaces directory found at $PLUGINS_DIR"
        return 1
    fi

    ensure_config

    local discovered=0
    local imported=0

    for dir in "$PLUGINS_DIR"/*/; do
        [[ ! -d "$dir" ]] && continue

        local alias
        alias=$(basename "$dir")
        ((discovered++))

        # Get git remote
        local remote
        remote=$(git -C "$dir" remote get-url origin 2>/dev/null || echo "")

        if [[ -z "$remote" ]]; then
            echo -e "  ${YELLOW}⚠${NC}  $alias ${DIM}(no git remote, skipping)${NC}"
            continue
        fi

        # Parse org/repo from remote
        local repo
        repo=$(parse_repo_from_remote "$remote")

        if [[ -z "$repo" ]]; then
            echo -e "  ${YELLOW}⚠${NC}  $alias ${DIM}(could not parse repo from: $remote)${NC}"
            continue
        fi

        # Check if already in config
        local existing_alias
        existing_alias=$(get_alias "$repo")

        if [[ -n "$existing_alias" ]]; then
            echo -e "  ${DIM}✓${NC}  $alias ${DIM}($repo already configured)${NC}"
        else
            # Add to config
            add_marketplace_to_config "$repo" "$alias"
            echo -e "  ${GREEN}+${NC}  $alias ${DIM}($repo)${NC}"
            ((imported++))
        fi
    done

    echo
    echo -e "Discovered ${discovered} marketplace(s), imported ${GREEN}${imported}${NC} new."
}

# Add marketplace to config (internal helper)
add_marketplace_to_config() {
    local repo="$1"
    local alias="$2"

    if grep -q "^  ${repo}:" "$CONFIG_FILE" 2>/dev/null; then
        # Update existing
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s|^  ${repo}:.*|  ${repo}: ${alias}|" "$CONFIG_FILE"
        else
            sed -i "s|^  ${repo}:.*|  ${repo}: ${alias}|" "$CONFIG_FILE"
        fi
    else
        # Add new entry
        if grep -q "^marketplaces: {}" "$CONFIG_FILE"; then
            # Replace empty marketplaces
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' "s|^marketplaces: {}|marketplaces:\\
  ${repo}: ${alias}|" "$CONFIG_FILE"
            else
                sed -i "s|^marketplaces: {}|marketplaces:\\n  ${repo}: ${alias}|" "$CONFIG_FILE"
            fi
        else
            # Append to marketplaces section
            if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' "/^marketplaces:/a\\
  ${repo}: ${alias}
" "$CONFIG_FILE"
            else
                sed -i "/^marketplaces:/a\\  ${repo}: ${alias}" "$CONFIG_FILE"
            fi
        fi
    fi
}

# Add a marketplace mapping
# Check if a plugin with the given name exists in any marketplace
find_plugins_by_name() {
    local plugin_name="$1"
    local installed_json="$HOME/.claude/plugins/installed_plugins.json"

    if [[ ! -f "$installed_json" ]]; then
        return
    fi

    jq -r --arg plugin "$plugin_name" '
        .plugins // {} | keys[] |
        select(startswith($plugin + "@"))
    ' "$installed_json" 2>/dev/null
}

cmd_add() {
    local repo="$1"
    local alias="$2"

    ensure_config

    # Warn if alias conflicts with an installed plugin name
    local conflicts
    conflicts=$(find_plugins_by_name "$alias")
    if [[ -n "$conflicts" ]]; then
        echo -e "${YELLOW}Warning:${NC} Alias '$alias' matches installed plugin(s):"
        echo "$conflicts" | while read -r p; do
            echo "  - $p"
        done
        echo "This may cause confusion when using 'ccpm list $alias'."
        echo
    fi

    add_marketplace_to_config "$repo" "$alias"
    echo -e "${GREEN}Added${NC} ${repo} -> ${alias}"
}

# Remove a marketplace mapping
cmd_remove() {
    local repo="$1"

    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "No config file found"
        return 1
    fi

    if ! grep -q "^  ${repo}:" "$CONFIG_FILE" 2>/dev/null; then
        echo "Marketplace not found: $repo"
        return 1
    fi

    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "\|^  ${repo}:|d" "$CONFIG_FILE"
    else
        sed -i "\|^  ${repo}:|d" "$CONFIG_FILE"
    fi
    echo -e "${GREEN}Removed${NC} ${repo}"
}

# Get installed plugins for a marketplace alias
get_installed_plugins_for_marketplace() {
    local target_alias="$1"
    local installed_json="$HOME/.claude/plugins/installed_plugins.json"

    if [[ ! -f "$installed_json" ]]; then
        return
    fi

    # Parse JSON to find plugins matching @marketplace_alias
    # Format: "plugin_name@marketplace_alias": [...]
    jq -r --arg alias "$target_alias" '
        .plugins // {} | keys[] |
        select(endswith("@" + $alias)) |
        split("@")[0]
    ' "$installed_json" 2>/dev/null | sort
}

# Get installed plugin info (version and git hash) from installed_plugins.json
get_installed_plugin_info() {
    local plugin_name="$1"
    local marketplace_alias="$2"
    local installed_json="$HOME/.claude/plugins/installed_plugins.json"

    if [[ ! -f "$installed_json" ]]; then
        return
    fi

    # Return "version|githash" format
    jq -r --arg key "$plugin_name@$marketplace_alias" '
        .plugins[$key][0] | "\(.version // "")|\(.gitCommitSha // "" | .[0:7])"
    ' "$installed_json" 2>/dev/null
}

# Get marketplace git info (commit hash, date)
get_marketplace_git_info() {
    local marketplace_dir="$1"

    if [[ ! -d "$marketplace_dir/.git" ]]; then
        echo ""
        return
    fi

    local commit_hash commit_date
    commit_hash=$(git -C "$marketplace_dir" rev-parse --short HEAD 2>/dev/null || echo "")
    commit_date=$(git -C "$marketplace_dir" log -1 --format="%cr" 2>/dev/null || echo "")

    if [[ -n "$commit_hash" ]]; then
        echo "${commit_hash} (${commit_date})"
    fi
}

# List installed plugins matching a pattern (used by --plugins flag)
list_plugins_by_pattern() {
    local pattern="$1"
    local installed_json="$HOME/.claude/plugins/installed_plugins.json"

    if [[ ! -f "$installed_json" ]]; then
        echo "No plugins installed."
        return
    fi

    echo -e "${BLUE}Installed plugins matching '$pattern':${NC}"
    echo

    local found=0
    local results
    results=$(jq -r '.plugins // {} | keys[]' "$installed_json" 2>/dev/null | sort)

    while IFS= read -r key; do
        [[ -z "$key" ]] && continue

        local plugin_name="${key%@*}"
        local marketplace_alias="${key#*@}"

        # Match pattern against plugin name (case-insensitive)
        if ! echo "$plugin_name" | grep -qi "$pattern"; then
            continue
        fi

        ((found++))

        local plugin_info version git_hash
        plugin_info=$(get_installed_plugin_info "$plugin_name" "$marketplace_alias")
        version="${plugin_info%|*}"
        git_hash="${plugin_info#*|}"

        printf "  ${BLUE}%s${NC}@%s" "$plugin_name" "$marketplace_alias"
        if [[ -n "$version" ]]; then
            printf " ${DIM}v%s${NC}" "$version"
        fi
        if [[ -n "$git_hash" ]]; then
            printf " ${DIM}@%s${NC}" "$git_hash"
        fi
        echo
    done <<< "$results"

    echo
    if [[ $found -eq 0 ]]; then
        echo -e "${DIM}No installed plugins match '$pattern'${NC}"
    else
        echo -e "Found ${GREEN}$found${NC} installed plugin(s) matching '$pattern'"
    fi
}

# List configured marketplaces
cmd_list() {
    local filter_alias=""
    local plugin_pattern=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --plugins|-p)
                shift
                if [[ $# -lt 1 ]]; then
                    echo -e "${RED}Error:${NC} --plugins requires a pattern"
                    return 1
                fi
                plugin_pattern="$1"
                shift
                ;;
            *)
                filter_alias="$1"
                shift
                ;;
        esac
    done

    # If --plugins mode, use different listing
    if [[ -n "$plugin_pattern" ]]; then
        list_plugins_by_pattern "$plugin_pattern"
        return
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "No marketplaces configured."
        echo "Run 'ccpm discover' to import installed marketplaces."
        echo "Or add one with: ccpm add <org/repo> <alias>"
        return
    fi

    if [[ -z "$filter_alias" ]]; then
        echo -e "${BLUE}Configured marketplaces:${NC}"
    fi
    echo

    local found=false
    while IFS= read -r repo; do
        [[ -z "$repo" ]] && continue
        local alias
        alias=$(get_alias "$repo")

        # If filter specified, skip non-matching marketplaces
        if [[ -n "$filter_alias" ]] && [[ "$alias" != "$filter_alias" ]]; then
            continue
        fi
        found=true
        local marketplace_dir="$PLUGINS_DIR/$alias"
        local status=""
        local git_info=""

        if [[ -d "$marketplace_dir" ]]; then
            status="${GREEN}installed${NC}"
            git_info=$(get_marketplace_git_info "$marketplace_dir")
        else
            status="${YELLOW}not installed${NC}"
        fi

        # Print marketplace line
        printf "  ${BLUE}%s${NC} (%s) [%b]\n" "$alias" "$repo" "$status"
        if [[ -n "$git_info" ]]; then
            echo -e "    ${DIM}@ $git_info${NC}"
        fi

        # Get installed plugins for this marketplace
        local plugins
        plugins=$(get_installed_plugins_for_marketplace "$alias")

        if [[ -n "$plugins" ]]; then
            while IFS= read -r plugin; do
                [[ -z "$plugin" ]] && continue
                local plugin_info version git_hash
                plugin_info=$(get_installed_plugin_info "$plugin" "$alias")
                version="${plugin_info%|*}"
                git_hash="${plugin_info#*|}"

                printf "    ${DIM}└─${NC} %s" "$plugin"
                if [[ -n "$version" ]]; then
                    printf " ${DIM}v%s${NC}" "$version"
                fi
                if [[ -n "$git_hash" ]]; then
                    printf " ${DIM}@%s${NC}" "$git_hash"
                fi
                echo
            done <<< "$plugins"
        else
            echo -e "    ${DIM}(no plugins installed)${NC}"
        fi
        echo
    done < <(get_all_repos)

    if [[ -n "$filter_alias" ]] && [[ "$found" == false ]]; then
        echo -e "${RED}Error:${NC} Marketplace '$filter_alias' not found"
        echo "Run 'ccpm list' to see configured marketplaces."
        return 1
    fi
}

# Get list of changed plugin directories between two commits
get_changed_plugins() {
    local marketplace_dir="$1"
    local old_hash="$2"
    local new_hash="$3"

    # Get list of changed files, extract top-level directories that are plugins
    git -C "$marketplace_dir" diff --name-only "$old_hash" "$new_hash" 2>/dev/null | \
        cut -d'/' -f1 | \
        sort -u | \
        while read -r dir; do
            # Only include if it's a plugin directory
            if [[ -d "$marketplace_dir/$dir/.claude-plugin" ]]; then
                echo "$dir"
            fi
        done
}

# Update marketplace catalogs (like apt update)
# Returns changed plugins info but doesn't reinstall
do_update() {
    local aliases=("$@")

    echo -e "${BLUE}=== Fetching marketplace updates ===${NC}"
    echo

    local total_available=0

    for alias in "${aliases[@]}"; do
        local marketplace_dir="$PLUGINS_DIR/$alias"

        if [[ ! -d "$marketplace_dir" ]]; then
            echo -e "  ${DIM}$alias: not installed, skipping${NC}"
            continue
        fi

        # Get current commit hash
        local old_hash
        old_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ -z "$old_hash" ]]; then
            echo -e "  ${YELLOW}$alias: not a git repo, skipping${NC}"
            continue
        fi

        echo -n "  $alias... "

        # Update the marketplace
        claude plugin marketplace update "$alias" >/dev/null 2>&1 || true

        # Get new commit hash
        local new_hash
        new_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ "$old_hash" == "$new_hash" ]]; then
            echo -e "${DIM}up to date${NC}"
            continue
        fi

        # Get list of changed plugins
        local changed
        changed=$(get_changed_plugins "$marketplace_dir" "$old_hash" "$new_hash")

        if [[ -z "$changed" ]]; then
            echo -e "${DIM}updated (no plugin changes)${NC}"
            continue
        fi

        local count
        count=$(echo "$changed" | wc -l | tr -d ' ')
        echo -e "${GREEN}${count} plugin(s) can be upgraded${NC}"
        ((total_available += count))

        # List changed plugins
        while IFS= read -r plugin_name; do
            [[ -z "$plugin_name" ]] && continue
            echo -e "    ${DIM}$plugin_name${NC}"
        done <<< "$changed"
    done

    echo
    if [[ $total_available -eq 0 ]]; then
        echo -e "${DIM}All plugins up to date.${NC}"
    else
        echo -e "${YELLOW}${total_available} plugin(s) can be upgraded.${NC} Run 'ccpm upgrade' to install."
    fi
}

# Upgrade plugins (like apt upgrade)
# Fetches updates and reinstalls changed plugins
do_upgrade() {
    local dry_run="$1"
    shift
    local aliases=("$@")

    if [[ "$dry_run" == true ]]; then
        echo "DRY RUN MODE - no changes will be made"
        echo
    fi

    echo -e "${BLUE}=== Upgrading plugins ===${NC}"
    echo

    local total_updated=0
    local any_changes=false

    for alias in "${aliases[@]}"; do
        local marketplace_dir="$PLUGINS_DIR/$alias"

        if [[ ! -d "$marketplace_dir" ]]; then
            echo -e "  ${DIM}$alias: not installed, skipping${NC}"
            continue
        fi

        # Get current commit hash
        local old_hash
        old_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ -z "$old_hash" ]]; then
            echo -e "  ${YELLOW}$alias: not a git repo, skipping${NC}"
            continue
        fi

        echo -n "  $alias... "

        if [[ "$dry_run" == false ]]; then
            # Update the marketplace
            claude plugin marketplace update "$alias" >/dev/null 2>&1 || true
        fi

        # Get new commit hash
        local new_hash
        new_hash=$(git -C "$marketplace_dir" rev-parse HEAD 2>/dev/null || echo "")

        if [[ "$old_hash" == "$new_hash" ]]; then
            echo -e "${DIM}up to date${NC}"
            continue
        fi

        # Get list of changed plugins
        local changed
        changed=$(get_changed_plugins "$marketplace_dir" "$old_hash" "$new_hash")

        if [[ -z "$changed" ]]; then
            echo -e "${DIM}no plugin changes${NC}"
            continue
        fi

        local count
        count=$(echo "$changed" | wc -l | tr -d ' ')
        echo -e "${GREEN}${count} plugin(s) to upgrade${NC}"
        any_changes=true

        # Reinstall changed plugins
        while IFS= read -r plugin_name; do
            [[ -z "$plugin_name" ]] && continue

            echo -n "    $plugin_name... "

            if [[ "$dry_run" == true ]]; then
                echo "would reinstall"
            else
                # Uninstall and reinstall
                if claude plugin uninstall "$plugin_name@$alias" >/dev/null 2>&1; then
                    if claude plugin install "$plugin_name@$alias" >/dev/null 2>&1; then
                        echo -e "${GREEN}upgraded${NC}"
                        ((total_updated++))
                    else
                        echo "failed to install"
                    fi
                else
                    # Maybe not installed, try just installing
                    if claude plugin install "$plugin_name@$alias" >/dev/null 2>&1; then
                        echo -e "${GREEN}installed${NC}"
                        ((total_updated++))
                    else
                        echo "failed"
                    fi
                fi
            fi
        done <<< "$changed"
    done

    echo
    if [[ "$any_changes" == false ]]; then
        echo -e "${DIM}All plugins up to date.${NC}"
    else
        echo -e "${GREEN}Done!${NC} Upgraded $total_updated plugin(s)."
    fi
}

# Get target aliases from repos or all configured
get_target_aliases() {
    local target_repos=("$@")
    local target_aliases=()

    if [[ ${#target_repos[@]} -gt 0 ]]; then
        for repo in "${target_repos[@]}"; do
            local alias
            alias=$(get_alias "$repo")
            if [[ -z "$alias" ]]; then
                echo -e "${RED}Error:${NC} Unknown marketplace '$repo'" >&2
                echo "Run 'ccpm discover' or add it with: ccpm add $repo <alias>" >&2
                return 1
            fi
            target_aliases+=("$alias")
        done
    else
        # No specific repos, use all configured
        while IFS= read -r repo; do
            [[ -z "$repo" ]] && continue
            local alias
            alias=$(get_alias "$repo")
            [[ -n "$alias" ]] && target_aliases+=("$alias")
        done < <(get_all_repos)
    fi

    if [[ ${#target_aliases[@]} -eq 0 ]]; then
        echo "No marketplaces configured." >&2
        echo "Run 'ccpm discover' to import installed marketplaces." >&2
        echo "Or add one with: ccpm add <org/repo> <alias>" >&2
        return 1
    fi

    printf '%s\n' "${target_aliases[@]}"
}

# Update command (fetch catalogs, show available upgrades)
cmd_update() {
    local target_repos=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            */*)
                target_repos+=("$1")
                shift
                ;;
            *)
                echo -e "${RED}Error:${NC} Unknown argument '$1'"
                return 1
                ;;
        esac
    done

    local target_aliases
    if ! target_aliases=$(get_target_aliases "${target_repos[@]+"${target_repos[@]}"}"); then
        return 1
    fi

    # shellcheck disable=SC2086
    do_update $target_aliases
}

# Upgrade command (update + reinstall changed plugins)
cmd_upgrade() {
    local dry_run=false
    local target_repos=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                dry_run=true
                shift
                ;;
            */*)
                target_repos+=("$1")
                shift
                ;;
            *)
                echo -e "${RED}Error:${NC} Unknown argument '$1'"
                return 1
                ;;
        esac
    done

    local target_aliases
    if ! target_aliases=$(get_target_aliases "${target_repos[@]+"${target_repos[@]}"}"); then
        return 1
    fi

    # shellcheck disable=SC2086
    do_upgrade "$dry_run" $target_aliases
}

# Search for plugins in local marketplace repos
cmd_search() {
    local query=""
    local verbose=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -v|--verbose)
                verbose=true
                shift
                ;;
            *)
                query="$1"
                shift
                ;;
        esac
    done

    if [[ -z "$query" ]]; then
        echo -e "${RED}Error:${NC} No search query specified"
        echo "Usage: ccpm search <query> [-v|--verbose]"
        return 1
    fi

    echo -e "${BLUE}=== Searching for '$query' ===${NC}"
    echo

    local found=0
    local installed_json="$HOME/.claude/plugins/installed_plugins.json"

    # Search through each marketplace
    for marketplace_dir in "$PLUGINS_DIR"/*/; do
        [[ ! -d "$marketplace_dir" ]] && continue

        local marketplace_alias
        marketplace_alias=$(basename "$marketplace_dir")

        # Search through plugin directories in this marketplace
        for plugin_dir in "$marketplace_dir"/*/; do
            [[ ! -d "$plugin_dir" ]] && continue
            [[ ! -d "$plugin_dir/.claude-plugin" ]] && continue

            local plugin_name
            plugin_name=$(basename "$plugin_dir")

            # Skip hidden directories and the marketplace's own .claude-plugin
            [[ "$plugin_name" == .* ]] && continue

            # Get plugin info from plugin.json
            local plugin_json="$plugin_dir/.claude-plugin/plugin.json"
            local description=""
            local version=""

            if [[ -f "$plugin_json" ]]; then
                description=$(jq -r '.description // ""' "$plugin_json" 2>/dev/null || echo "")
                version=$(jq -r '.version // ""' "$plugin_json" 2>/dev/null || echo "")
            fi

            # Match against name or description (case-insensitive)
            local match=false
            if echo "$plugin_name" | grep -qi "$query"; then
                match=true
            elif echo "$description" | grep -qi "$query"; then
                match=true
            fi

            if [[ "$match" == true ]]; then
                ((found++))

                # Check if installed
                local installed_marker=""
                if [[ -f "$installed_json" ]] && jq -e --arg key "$plugin_name@$marketplace_alias" '.plugins[$key]' "$installed_json" >/dev/null 2>&1; then
                    installed_marker=" ${GREEN}[installed]${NC}"
                fi

                # Print result
                printf "  ${BLUE}%s${NC}@%s" "$plugin_name" "$marketplace_alias"
                if [[ -n "$version" ]]; then
                    printf " ${DIM}v%s${NC}" "$version"
                fi
                echo -e "$installed_marker"

                if [[ "$verbose" == true ]] && [[ -n "$description" ]]; then
                    echo -e "    ${DIM}$description${NC}"
                fi
            fi
        done
    done

    echo
    if [[ $found -eq 0 ]]; then
        echo -e "${DIM}No plugins found matching '$query'${NC}"
    else
        echo -e "Found ${GREEN}$found${NC} plugin(s) matching '$query'"
    fi
}

# Uninstall one or more plugins
cmd_uninstall() {
    local plugins=("$@")

    if [[ ${#plugins[@]} -eq 0 ]]; then
        echo -e "${RED}Error:${NC} No plugins specified"
        echo "Usage: ccpm uninstall <plugin@marketplace> [plugin@marketplace...]"
        echo "       ccpm uninstall --all <marketplace-alias>"
        return 1
    fi

    # Check for --all mode (uninstall all plugins from a marketplace)
    if [[ "${plugins[0]}" == "--all" ]]; then
        if [[ ${#plugins[@]} -lt 2 ]]; then
            echo -e "${RED}Error:${NC} --all requires a marketplace alias"
            echo "Usage: ccpm uninstall --all <marketplace-alias>"
            return 1
        fi
        local marketplace_alias="${plugins[1]}"
        local installed
        installed=$(get_installed_plugins_for_marketplace "$marketplace_alias")

        if [[ -z "$installed" ]]; then
            echo -e "${YELLOW}No plugins installed from $marketplace_alias${NC}"
            return 0
        fi

        plugins=()
        while IFS= read -r plugin; do
            [[ -z "$plugin" ]] && continue
            plugins+=("$plugin@$marketplace_alias")
        done <<< "$installed"
    fi

    echo -e "${BLUE}=== Uninstalling plugins ===${NC}"
    echo

    local success=0
    local failed=0

    for plugin_spec in "${plugins[@]}"; do
        # Parse plugin@marketplace format
        local plugin_name marketplace_alias

        if [[ "$plugin_spec" == *@* ]]; then
            plugin_name="${plugin_spec%@*}"
            marketplace_alias="${plugin_spec#*@}"
        else
            # Try to find the marketplace for this plugin
            plugin_name="$plugin_spec"
            if ! marketplace_alias=$(find_marketplace_for_plugin "$plugin_name"); then
                # Ambiguous - error message already printed
                ((failed++))
                continue
            fi

            if [[ -z "$marketplace_alias" ]]; then
                echo -e "  ${RED}✗${NC} $plugin_name - not found in any marketplace"
                ((failed++))
                continue
            fi
        fi

        echo -n "  $plugin_name@$marketplace_alias... "

        if claude plugin uninstall "$plugin_name@$marketplace_alias" >/dev/null 2>&1; then
            echo -e "${GREEN}uninstalled${NC}"
            ((success++))
        else
            echo -e "${RED}failed${NC}"
            ((failed++))
        fi
    done

    echo
    if [[ $failed -eq 0 ]]; then
        echo -e "${GREEN}Done!${NC} Uninstalled $success plugin(s)."
    else
        echo -e "${YELLOW}Done.${NC} Uninstalled $success, failed $failed."
        return 1
    fi
}

# Reinstall one or more plugins
cmd_reinstall() {
    local dry_run=false
    local plugins=()

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                dry_run=true
                shift
                ;;
            *)
                plugins+=("$1")
                shift
                ;;
        esac
    done

    if [[ ${#plugins[@]} -eq 0 ]]; then
        echo -e "${RED}Error:${NC} No plugins specified"
        echo "Usage: ccpm reinstall <plugin@marketplace> [plugin@marketplace...]"
        echo "       ccpm reinstall --all <marketplace-alias>"
        return 1
    fi

    # Check for --all mode (reinstall all plugins from a marketplace)
    if [[ "${plugins[0]}" == "--all" ]]; then
        if [[ ${#plugins[@]} -lt 2 ]]; then
            echo -e "${RED}Error:${NC} --all requires a marketplace alias"
            echo "Usage: ccpm reinstall --all <marketplace-alias>"
            return 1
        fi
        local marketplace_alias="${plugins[1]}"
        local installed
        installed=$(get_installed_plugins_for_marketplace "$marketplace_alias")

        if [[ -z "$installed" ]]; then
            echo -e "${YELLOW}No plugins installed from $marketplace_alias${NC}"
            return 0
        fi

        plugins=()
        while IFS= read -r plugin; do
            [[ -z "$plugin" ]] && continue
            plugins+=("$plugin@$marketplace_alias")
        done <<< "$installed"
    fi

    if [[ "$dry_run" == true ]]; then
        echo "DRY RUN MODE - no changes will be made"
        echo
    fi

    echo -e "${BLUE}=== Reinstalling plugins ===${NC}"
    echo

    local success=0
    local failed=0

    for plugin_spec in "${plugins[@]}"; do
        # Parse plugin@marketplace format
        local plugin_name marketplace_alias

        if [[ "$plugin_spec" == *@* ]]; then
            plugin_name="${plugin_spec%@*}"
            marketplace_alias="${plugin_spec#*@}"
        else
            # Try to find the marketplace for this plugin
            plugin_name="$plugin_spec"
            if ! marketplace_alias=$(find_marketplace_for_plugin "$plugin_name"); then
                # Ambiguous - error message already printed
                ((failed++))
                continue
            fi

            if [[ -z "$marketplace_alias" ]]; then
                echo -e "  ${RED}✗${NC} $plugin_name - not found in any marketplace"
                ((failed++))
                continue
            fi
        fi

        echo -n "  $plugin_name@$marketplace_alias... "

        if [[ "$dry_run" == true ]]; then
            echo "would reinstall"
            ((success++))
            continue
        fi

        # Uninstall first (ignore errors - might not be installed)
        claude plugin uninstall "$plugin_name@$marketplace_alias" >/dev/null 2>&1 || true

        # Install
        if claude plugin install "$plugin_name@$marketplace_alias" >/dev/null 2>&1; then
            echo -e "${GREEN}reinstalled${NC}"
            ((success++))
        else
            echo -e "${RED}failed${NC}"
            ((failed++))
        fi
    done

    echo
    if [[ $failed -eq 0 ]]; then
        echo -e "${GREEN}Done!${NC} Reinstalled $success plugin(s)."
    else
        echo -e "${YELLOW}Done.${NC} Reinstalled $success, failed $failed."
        return 1
    fi
}

# Find which marketplace a plugin is installed from
# Returns 1 if plugin exists in multiple marketplaces (ambiguous)
find_marketplace_for_plugin() {
    local plugin_name="$1"
    local installed_json="$HOME/.claude/plugins/installed_plugins.json"

    if [[ ! -f "$installed_json" ]]; then
        return
    fi

    # Find all marketplaces containing this plugin
    local matches
    matches=$(jq -r --arg plugin "$plugin_name" '
        .plugins // {} | keys[] |
        select(startswith($plugin + "@")) |
        split("@")[1]
    ' "$installed_json" 2>/dev/null)

    if [[ -z "$matches" ]]; then
        return
    fi

    # Count matches
    local count
    count=$(echo "$matches" | wc -l | tr -d ' ')

    if [[ $count -gt 1 ]]; then
        echo -e "${YELLOW}Ambiguous:${NC} '$plugin_name' exists in multiple marketplaces:" >&2
        echo "$matches" | while read -r mp; do
            echo "  - $plugin_name@$mp" >&2
        done
        echo "Please specify explicitly: <command> $plugin_name@<marketplace>" >&2
        return 1
    fi

    echo "$matches"
}

# Check for naming conflicts between marketplaces and plugins
cmd_check_conflicts() {
    echo -e "${BLUE}=== Checking for Naming Conflicts ===${NC}"
    echo

    local installed_json="$HOME/.claude/plugins/installed_plugins.json"
    local conflicts_found=0

    # Check 1: Plugins installed in multiple marketplaces
    echo -e "${BLUE}Plugins in multiple marketplaces:${NC}"
    local multi_mp_plugins=()

    if [[ -f "$installed_json" ]]; then
        # Get all plugin names (without @marketplace)
        local all_plugins
        all_plugins=$(jq -r '.plugins // {} | keys[] | split("@")[0]' "$installed_json" 2>/dev/null | sort)

        local prev=""
        while IFS= read -r plugin; do
            [[ -z "$plugin" ]] && continue
            if [[ "$plugin" == "$prev" ]]; then
                # Duplicate found - check if already in array
                local already_added=false
                if [[ ${#multi_mp_plugins[@]} -gt 0 ]]; then
                    for existing in "${multi_mp_plugins[@]}"; do
                        if [[ "$existing" == "$plugin" ]]; then
                            already_added=true
                            break
                        fi
                    done
                fi
                if [[ "$already_added" == false ]]; then
                    multi_mp_plugins+=("$plugin")
                fi
            fi
            prev="$plugin"
        done <<< "$all_plugins"

        if [[ ${#multi_mp_plugins[@]} -gt 0 ]]; then
            for plugin in "${multi_mp_plugins[@]}"; do
                ((conflicts_found++))
                echo -e "  ${YELLOW}⚠${NC} $plugin:"
                jq -r --arg plugin "$plugin" '
                    .plugins // {} | keys[] |
                    select(startswith($plugin + "@"))
                ' "$installed_json" 2>/dev/null | while read -r full_key; do
                    echo "      - $full_key"
                done
            done
        else
            echo -e "  ${GREEN}✓${NC} None found"
        fi
    else
        echo -e "  ${DIM}No plugins installed${NC}"
    fi

    echo

    # Check 2: Marketplace aliases matching plugin names
    echo -e "${BLUE}Marketplace aliases matching plugin names:${NC}"
    local alias_conflicts=0

    while IFS= read -r repo; do
        [[ -z "$repo" ]] && continue
        local alias
        alias=$(get_alias "$repo")

        local matching_plugins
        matching_plugins=$(find_plugins_by_name "$alias")

        if [[ -n "$matching_plugins" ]]; then
            ((alias_conflicts++))
            ((conflicts_found++))
            echo -e "  ${YELLOW}⚠${NC} Marketplace alias '$alias' conflicts with:"
            echo "$matching_plugins" | while read -r p; do
                echo "      - $p"
            done
        fi
    done < <(get_all_repos)

    if [[ $alias_conflicts -eq 0 ]]; then
        echo -e "  ${GREEN}✓${NC} None found"
    fi

    echo
    echo -e "${BLUE}=== Summary ===${NC}"
    if [[ $conflicts_found -eq 0 ]]; then
        echo -e "${GREEN}No conflicts detected.${NC}"
    else
        echo -e "${YELLOW}$conflicts_found conflict(s) found.${NC}"
        echo "Use explicit 'plugin@marketplace' format to avoid ambiguity."
        return 1
    fi
}

# Show usage
usage() {
    cat << EOF
Usage: ccpm [options] <command>

Commands:
  discover               Discover and import installed marketplaces
  update [org/repo]      Fetch latest catalogs, show available upgrades
  upgrade [org/repo]     Fetch + reinstall changed plugins
  search <query>         Search for plugins in local marketplace repos
  reinstall <plugin@mp>  Reinstall specific plugin(s)
  uninstall <plugin@mp>  Uninstall specific plugin(s)
  add <org/repo> <alias> Add marketplace to config
  remove <org/repo>      Remove marketplace from config
  list [alias]           List configured marketplaces and plugins
  list --plugins <pat>   List installed plugins matching pattern
  check-conflicts        Check for naming conflicts
  config                 Show config file path and contents
  help                   Show this help

Options:
  --config <path>        Use alternate config file (default: $DEFAULT_CONFIG_FILE)
  --dry-run              Show what would happen without making changes
  -v, --verbose          Show additional details (for search)

Examples:
  ccpm discover                              # Import installed marketplaces
  ccpm update                                # Check for updates (like apt update)
  ccpm upgrade                               # Install updates (like apt upgrade)
  ccpm upgrade --dry-run                     # Preview what would be upgraded
  ccpm search trivy                          # Search for plugins matching 'trivy'
  ccpm search security -v                    # Search with descriptions
  ccpm reinstall trivy@plinde-plugins        # Reinstall a specific plugin
  ccpm reinstall trivy tmux                  # Reinstall multiple (auto-detect marketplace)
  ccpm reinstall --all plinde-plugins        # Reinstall all plugins from a marketplace
  ccpm uninstall trivy@plinde-plugins        # Uninstall a specific plugin
  ccpm uninstall --all plinde-plugins        # Uninstall all plugins from a marketplace
  ccpm add anthropics/skills anthropic-skills
  ccpm list
EOF
}

# Main
main() {
    # Pre-parse --config flag (must come before other args)
    local args=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --config)
                shift
                if [[ $# -lt 1 ]]; then
                    echo -e "${RED}Error:${NC} --config requires a path argument"
                    exit 1
                fi
                CONFIG_FILE="$1"
                shift
                ;;
            *)
                args+=("$1")
                shift
                ;;
        esac
    done
    set -- "${args[@]+"${args[@]}"}"

    # No arguments - show help
    if [[ $# -eq 0 ]]; then
        usage
        exit 0
    fi

    # Parse command
    local cmd="$1"
    shift

    case "$cmd" in
        discover)
            cmd_discover
            ;;
        update)
            cmd_update "$@"
            ;;
        upgrade)
            cmd_upgrade "$@"
            ;;
        search)
            cmd_search "$@"
            ;;
        reinstall)
            cmd_reinstall "$@"
            ;;
        uninstall)
            cmd_uninstall "$@"
            ;;
        add)
            if [[ $# -lt 2 ]]; then
                echo "Usage: ccpm add <org/repo> <alias>"
                exit 1
            fi
            cmd_add "$1" "$2"
            ;;
        remove)
            if [[ $# -lt 1 ]]; then
                echo "Usage: ccpm remove <org/repo>"
                exit 1
            fi
            cmd_remove "$1"
            ;;
        list)
            cmd_list "$@"
            ;;
        check-conflicts)
            cmd_check_conflicts
            ;;
        config)
            cmd_config
            ;;
        help|--help|-h)
            usage
            ;;
        *)
            echo -e "${RED}Error:${NC} Unknown command '$cmd'"
            echo "Run 'ccpm help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
